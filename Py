import json
import csv
import re
from datetime import datetime

# Load the JSON data from file
with open(r'C:\repo\json\PROD\PA.json') as json_file:
    jsondata = json.load(json_file)

# Function to flatten JSON and get key-value pairs
def extract_key_values(json_obj, parent_key=''):
    items = {}
    if isinstance(json_obj, dict):
        for k, v in json_obj.items():
            new_key = f"{parent_key}.{k}" if parent_key else k
            items.update(extract_key_values(v, new_key))
    elif isinstance(json_obj, list):
        for i, v in enumerate(json_obj):
            new_key = f"{parent_key}[{i}]" if parent_key else str(i)
            items.update(extract_key_values(v, new_key))
    else:
        items[parent_key] = json_obj
    return items

# Ensure jsondata is a list
if isinstance(jsondata, dict):
    jsondata = [jsondata]

# Extract key-value pairs from each JSON entry
all_key_values = []
for entry in jsondata:
    all_key_values.append(extract_key_values(entry))

# Write to CSV
timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
csv_file_path = f'C:\\repo\\json\\PROD\\PA_{timestamp}.csv'

# Get all unique keys for the CSV header
header_keys = set()
for item in all_key_values:
    header_keys.update(item.keys())

header_keys = sorted(header_keys)  # Sort headers for consistent column order

with open(csv_file_path, 'w', newline='') as data_file:
    csv_writer = csv.DictWriter(data_file, fieldnames=header_keys)
    csv_writer.writeheader()
    for item in all_key_values:
        csv_writer.writerow(item)

print(f"Data successfully written to {csv_file_path}")
