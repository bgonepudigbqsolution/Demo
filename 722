Option Explicit

Sub ConvertJSONtoCSV()
    Dim jsonFilePath As String
    Dim csvFilePath As String
    Dim jsonFileContent As String
    Dim jsonObject As Object
    Dim jsonItems As Collection
    Dim jsonItem As Object
    Dim header As Collection
    Dim dataRows As Collection
    Dim headerNames() As String
    Dim i As Integer, j As Integer
    Dim csvContent As String
    
    ' File paths
    jsonFilePath = "C:\repo\json\PROD\PA.json" ' Update this path
    csvFilePath = "C:\repo\json\PROD\PA_output.csv" ' Update this path
    
    ' Read JSON file content
    jsonFileContent = GetFileContent(jsonFilePath)
    
    ' Parse JSON content
    Set jsonObject = JsonConverter.ParseJson(jsonFileContent)
    
    ' Assuming JSON data is a collection of objects
    If TypeName(jsonObject) = "Collection" Then
        Set jsonItems = jsonObject
    Else
        MsgBox "Unexpected JSON format", vbExclamation
        Exit Sub
    End If
    
    ' Initialize header and data rows collections
    Set header = New Collection
    Set dataRows = New Collection
    
    ' Extract headers and data rows
    For Each jsonItem In jsonItems
        For Each key In jsonItem.Keys
            On Error Resume Next
            header.Add key, key
            On Error GoTo 0
        Next key
        
        ' Create a collection for the row
        Dim row As New Collection
        For Each key In header
            row.Add IIf(IsMissing(jsonItem(key)), "", jsonItem(key))
        Next key
        dataRows.Add row
    Next jsonItem
    
    ' Create CSV content
    ReDim headerNames(header.Count - 1)
    For i = 1 To header.Count
        headerNames(i - 1) = header(i)
    Next i
    
    csvContent = Join(headerNames, ",") & vbCrLf
    
    For i = 1 To dataRows.Count
        Dim dataRow As Collection
        Set dataRow = dataRows(i)
        
        Dim rowData() As String
        ReDim rowData(dataRow.Count - 1)
        
        For j = 1 To dataRow.Count
            rowData(j - 1) = dataRow(j)
        Next j
        
        csvContent = csvContent & Join(rowData, ",") & vbCrLf
    Next i
    
    ' Write CSV content to file
    SaveFileContent csvFilePath, csvContent
    
    MsgBox "Data successfully written to " & csvFilePath
End Sub

Function GetFileContent(filePath As String) As String
    Dim fileContent As String
    Dim fileNum As Integer
    fileNum = FreeFile
    Open filePath For Input As fileNum
    fileContent = Input$(LOF(fileNum), fileNum)
    Close fileNum
    GetFileContent = fileContent
End Function

Sub SaveFileContent(filePath As String, content As String)
    Dim fileNum As Integer
    fileNum = FreeFile
    Open filePath For Output As fileNum
    Print #fileNum, content
    Close fileNum
End Sub
